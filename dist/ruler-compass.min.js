/*! ruler-compass - v0.0.0 - 2013-01-14
 * https://github.com/dvberkel/ruler-compass
 * Copyright (c) 2013 Daan van Berkel; Licensed MIT
 */
Geometry={version:"0.0.0"},function(e,t,n){var r=function(e){var t=0;this.nextName=function(){return e+t++}},i=t.Model.extend({defaults:{type:"point",x:0,y:0},updateFromResult:function(e){this.set(e),this.trigger("updatedFromResult")},updateFromCode:function(e){this.set(e),this.trigger("updatedFromCode")}}),s=t.Model.extend({defaults:{type:"line",P0:"A",P1:"B"}}),o=t.Model.extend({defaults:{type:"circle",P0:"A",P1:"B"}}),u=t.Model.extend({name:function(e){e&&this.set("name",e);if(!this.has("name")){var t=this;this.trigger("request:name",t.object().get("type"),function(e){t.name(e)})}return e||this.get("name")},point:function(){return this.has("point")||this.set("point",new i),this.get("point")},object:function(){return this.get("object")}}),a=t.Collection.extend({model:u,initialize:function(){this.generators={point:new r("P"),line:new r("l"),circle:new r("c")}},append:function(e){e.on("request:name",this.provideName,this),this.add(e)},provideName:function(e,t){t.call(null,this.generators[e].nextName())},lastPointsName:function(t){var n={},r=this.filter(function(e){return e.object().get("type")==="point"}).slice(-t);return e.each(r,function(e,t){n["P"+t]=e.name()}),n},lookUp:function(e){return this.find(function(t){return t.name()===e})}});n.Point=i,n.Line=s,n.Circle=o,n.ConstructionStep=u,n.Construction=a}(_,Backbone,Geometry),function(e,t,n,r,i){var s=n.View.extend({initialize:function(){this.model||(this.model=new i.Construction),this.render()},render:function(){new o({el:this.$el,model:this.model}),new h({el:this.$el,model:this.model}),new S({el:this.$el,model:this.model})}}),o=n.View.extend({initialize:function(){this.render()},render:function(){var t=e("<div class='parts'/>");t.appendTo(this.$el),new u({el:t,model:this.model}),new f({el:t,model:this.model})}}),u=n.View.extend({initialize:function(){this.render()},render:function(){var t=e("<div class='free'/>");t.appendTo(this.$el),new a({el:t,model:this.model})}}),a=n.View.extend({initialize:function(){this.render()},render:function(){var t=e("<span class='point'>Point</span>");t.appendTo(this.$el);var n=this.model;t.click(function(){n.append(new i.ConstructionStep({object:new i.Point}))})}}),f=n.View.extend({initialize:function(){this.render()},render:function(){var t=e("<div class='constructions'/>");t.appendTo(this.$el),new l({el:t,model:this.model}),new c({el:t,model:this.model})}}),l=n.View.extend({initialize:function(){this.render()},render:function(){var t=e("<span class='line'>Line</span>");t.appendTo(this.$el);var n=this.model;t.click(function(){var e=n.lastPointsName(2);n.append(new i.ConstructionStep({object:new i.Line(e)}))})}}),c=n.View.extend({initialize:function(){this.render()},render:function(){var t=e("<span class='circle'>Circle</span>");t.appendTo(this.$el);var n=this.model;t.click(function(){var e=n.lastPointsName(2);n.append(new i.ConstructionStep({object:new i.Circle(e)}))})}}),h=n.View.extend({initialize:function(){this.model.on("add",function(e){var t=this.container();new p({el:t,model:e})},this),this.render()},render:function(){var e=this.container()},container:function(){return this._container===undefined&&(this._container=e("<div class='code'/>"),this._container.appendTo(this.$el)),this._container}}),p=n.View.extend({template:t.template("<div class='<%= type %>'/>"),initialize:function(){this.render()},render:function(){var e=this.container();new d({el:e,model:this.model}),new m({el:e,model:this.model})},container:function(){return this._container===undefined&&(this._container=e(this.template(this.model.object().toJSON())),this._container.appendTo(this.$el)),this._container}}),d=n.View.extend({initialize:function(){this.render()},render:function(){var e=this.container();new v({el:e,model:this.model})},container:function(){return this._container===undefined&&(this._container=e("<span class='names'/>"),this._container.appendTo(this.$el)),this._container}}),v=n.View.extend({initialize:function(){this.render()},render:function(){var e=this.container();e.empty().text(this.model.name())},container:function(){return this._container===undefined&&(this._container=e("<span class='name'/>"),this._container.appendTo(this.$el)),this._container}}),m=n.View.extend({initialize:function(){this.descriptions={point:g,line:w,circle:E},this.render()},render:function(){var e=this.container();new(this.descriptions[this.model.object().get("type")])({model:this.model.object(),el:e})},container:function(){return this._container===undefined&&(this._container=e("<span class='description'/>"),this._container.appendTo(this.$el)),this._container}}),g=n.View.extend({template:t.template("<span class='free-point'>(<span class='coordinate x'><%= x %></span>,<span class='coordinate y'><%= y %></span>)</span>"),initialize:function(){this.render()},render:function(){var e=this.container();new y({model:this.model,el:e.find(".x"),coordinate:"x"}),new y({model:this.model,el:e.find(".y"),coordinate:"y"})},container:function(){return this._container===undefined&&(this._container=e(this.template(this.model.toJSON())),this._container.appendTo(this.$el)),this._container}}),y=n.View.extend({initialize:function(){var e=this;e.render(),e.model.on("updatedFromResult",e.render,e),e.model.on("updatedFromCode",e.render,e);var t=0,n=0,r=b(function(r){t=r.screenX,n=e.model.get(e.options.coordinate)},function(r){var i={};i[e.options.coordinate]=n+(r.screenX-t),e.model.updateFromCode(i)});e.container().mousedown(r)},render:function(){var e=this.container();e.empty().text(this.model.get(this.options.coordinate))},container:function(){return this.$el}}),b=function(t,n,r){var i=function(){};t=t||i,n=n||i,r=r||i;var s=function(n){e("body").on("mousemove",o),e("body").on("mouseup",u),t.call(n,n)},o=function(e){n.call(e,e)},u=function(t){e("body").off("mousemove",o),e("body").off("mouseup",u),r.call(t,t)};return s},w=n.View.extend({template:t.template("<span class='line'>l(<span class='reference-point'><%= P0 %></span>,<span class='reference-point'><%= P1 %></span>)</span>"),initialize:function(){this.render()},render:function(){var e=this.container()},container:function(){return this._container===undefined&&(this._container=e(this.template(this.model.toJSON())),this._container.appendTo(this.$el)),this._container}}),E=n.View.extend({template:t.template("<span class='circle'><span class='reference-point'><%= P0 %></span><sub><span class='reference-point'><%= P1 %></span></sub></span>"),initialize:function(){this.render()},render:function(){var e=this.container()},container:function(){return this._container===undefined&&(this._container=e(this.template(this.model.toJSON())),this._container.appendTo(this.$el)),this._container}}),S=n.View.extend({initialize:function(){this.render()},render:function(){var e=this.container();new x({model:this.model,el:e})},container:function(){return this._container===undefined&&(this._container=e("<div class='result' id='result'/>"),this._container.appendTo(this.$el)),this._container}}),x=n.View.extend({initialize:function(){var e=this.model;e.on("add",function(t){var n=this.paper();new N({model:t,paper:n,parent:e})},this),this.render()},render:function(){var e=this.paper();new T({model:this.model,paper:e})},paper:function(){return this._paper===undefined&&(this._paper=new r(this.$el.attr("id"),640,480),this._paper.setViewBox(-320,-240,640,480)),this._paper}}),T=n.View.extend({initialize:function(){this.render()},render:function(){var e=this.paper();e.path("M-320,0L640,0").attr({stroke:"#cccccc"}),e.path("M0,-240L0,480").attr({stroke:"#cccccc"})},paper:function(){return this.options.paper}}),N=n.View.extend({initialize:function(){this.types={point:C,line:k,circle:A},this.render()},render:function(){new(this.types[this.model.object().get("type")])({model:this.model.object(),paper:this.paper(),parent:this.parent()})},paper:function(){return this.options.paper},parent:function(){return this.options.parent}}),C=n.View.extend({initialize:function(){this.model.on("updatedFromCode",this.render,this),this.render()},render:function(){var e=this.point();e.attr({cx:this.model.get("x"),cy:this.model.get("y")})},point:function(){if(this._point===undefined){var e=this.paper();this._point=e.circle(0,0,3).attr({stroke:"black",fill:"black"}),this._point.node.setAttribute("class","point"),this._point.drag(function(e,t){var n=this.ox+e,r=this.oy+t;this.model.updateFromResult({x:n,y:r}),this.point().attr({cx:n,cy:r})},function(e,t){var n=this.point();this.ox=n.attr("cx"),this.oy=n.attr("cy")},function(){},this,this,this)}return this._point},paper:function(){return this.options.paper}}),k=n.View.extend({initialize:function(){this.render()},render:function(){var e=this.line();e.update()},line:function(){if(this._line===undefined){var e=this.paper(),t=this.parent().lookUp(this.model.get("P0")).object(),n=this.parent().lookUp(this.model.get("P1")).object();this._line=new L({A:t,B:n,paper:e}),t.on("change",this.render,this),n.on("change",this.render,this)}return this._line},paper:function(){return this.options.paper},parent:function(){return this.options.parent}}),L=function(e){var t=e.A,n=e.B,r=e.paper.path("M0,0L0,0").attr({stroke:"black"});r.node.setAttribute("class","line"),this.attr=function(e){r.attr(e)},this.update=function(){var e=[["M",t.get("x"),t.get("y")],["L",n.get("x"),n.get("y")]];this.attr({path:e})}},A=n.View.extend({initialize:function(){this.render()},render:function(){var e=this.circle();e.update()},circle:function(){if(this._circle===undefined){var e=this.paper(),t=this.parent().lookUp(this.model.get("P0")).object(),n=this.parent().lookUp(this.model.get("P1")).object();this._circle=new O({A:t,B:n,paper:e}),t.on("change",this.render,this),n.on("change",this.render,this)}return this._circle},paper:function(){return this.options.paper},parent:function(){return this.options.parent}}),O=function(e){var t=e.A,n=e.B,r=e.paper.circle(0,0,10).attr({stroke:"black"});r.node.setAttribute("class","circle"),this.attr=function(e){r.attr(e)},this.update=function(){var e=t.get("x"),r=t.get("y"),i=Math.sqrt(Math.pow(n.get("x")-e,2)+Math.pow(n.get("y")-r,2));this.attr({cx:e,cy:r,r:i})}};i.EnvironmentView=s}(jQuery,_,Backbone,Raphael,Geometry);